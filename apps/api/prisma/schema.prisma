generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum RoleName {
  ADMIN
  MANAGER
  USER
  READ_ONLY
}

enum PermissionAction {
  read
  create
  update
  delete
  assign
  export
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  RESTORE
}

enum DealStageKey {
  LEAD
  QUALIFIED
  PROPOSAL
  NEGOTIATION
  WON
  LOST
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
}

enum TaskStatus {
  OPEN
  IN_PROGRESS
  DONE
}

enum ActivityType {
  CALL
  MEETING
  EMAIL
  NOTE
}

model Tenant {
  id          String    @id @default(uuid())
  name        String
  slug        String    @unique
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")
  users       User[]
  teams       Team[]
  roles       Role[]
  accounts    Account[]
  pipelines   Pipeline[]
  tags        Tag[]
  auditLogs   AuditLog[]
  automations AutomationRule[]

  @@map("tenants")
}

model User {
  id          String    @id @default(uuid())
  tenantId    String    @map("tenant_id")
  email       String    @unique
  password    String
  name        String?
  roleId      String
  teamId      String?   @map("team_id")
  failedLoginAttempts Int @default(0) @map("failed_login_attempts")
  lockedUntil DateTime? @map("locked_until")
  lastFailedLoginAt DateTime? @map("last_failed_login_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  tenant   Tenant @relation(fields: [tenantId], references: [id])
  role     Role   @relation(fields: [roleId], references: [id])
  team     Team?  @relation(fields: [teamId], references: [id])
  accounts Account[] @relation("AccountOwner")
  deals    Deal[]    @relation("DealOwner")
  tasks    Task[]    @relation("TaskAssignee")
  refreshTokens RefreshToken[]

  @@index([tenantId, deletedAt])
  @@map("users")
}

model Team {
  id          String    @id @default(uuid())
  tenantId    String    @map("tenant_id")
  name        String
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])
  users  User[]

  @@index([tenantId, deletedAt])
  @@map("teams")
}

model Role {
  id          String    @id @default(uuid())
  tenantId    String    @map("tenant_id")
  name        RoleName
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  tenant       Tenant @relation(fields: [tenantId], references: [id])
  permissions  RolePermission[]
  users        User[]

  @@unique([tenantId, name])
  @@index([tenantId, deletedAt])
  @@map("roles")
}

model Permission {
  id          String            @id @default(uuid())
  tenantId    String            @map("tenant_id")
  action      PermissionAction
  resource    String
  createdAt   DateTime          @default(now()) @map("created_at")
  updatedAt   DateTime          @updatedAt @map("updated_at")
  deletedAt   DateTime?         @map("deleted_at")

  tenant       Tenant @relation(fields: [tenantId], references: [id])
  roles        RolePermission[]

  @@unique([tenantId, action, resource])
  @@index([tenantId, deletedAt])
  @@map("permissions")
}

model RolePermission {
  id           String @id @default(uuid())
  roleId       String @map("role_id")
  permissionId String @map("permission_id")

  role       Role       @relation(fields: [roleId], references: [id])
  permission Permission @relation(fields: [permissionId], references: [id])

  @@unique([roleId, permissionId])
  @@map("role_permissions")
}

model Account {
  id          String    @id @default(uuid())
  tenantId    String    @map("tenant_id")
  ownerId     String?   @map("owner_id")
  name        String
  website     String?
  industry    String?
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  tenant   Tenant @relation(fields: [tenantId], references: [id])
  owner    User?  @relation("AccountOwner", fields: [ownerId], references: [id])
  contacts Contact[]
  deals    Deal[]
  activities Activity[]
  tasks     Task[]
  notes     Note[]
  attachments Attachment[]
  entityTags EntityTag[]

  @@index([tenantId, deletedAt])
  @@index([tenantId, ownerId])
  @@map("accounts")
}

model Contact {
  id          String    @id @default(uuid())
  tenantId    String    @map("tenant_id")
  accountId   String    @map("account_id")
  name        String
  email       String?
  phone       String?
  title       String?
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  tenant   Tenant @relation(fields: [tenantId], references: [id])
  account  Account @relation(fields: [accountId], references: [id])
  activities Activity[]
  tasks    Task[]
  notes    Note[]
  attachments Attachment[]
  entityTags EntityTag[]

  @@index([tenantId, deletedAt])
  @@index([tenantId, accountId])
  @@map("contacts")
}

model Pipeline {
  id          String    @id @default(uuid())
  tenantId    String    @map("tenant_id")
  name        String
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])
  stages Stage[]
  deals  Deal[]

  @@unique([tenantId, name])
  @@index([tenantId, deletedAt])
  @@map("pipelines")
}

model Stage {
  id          String    @id @default(uuid())
  tenantId    String    @map("tenant_id")
  pipelineId  String    @map("pipeline_id")
  name        String
  key         DealStageKey
  order       Int
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  tenant   Tenant @relation(fields: [tenantId], references: [id])
  pipeline Pipeline @relation(fields: [pipelineId], references: [id])
  deals    Deal[]

  @@unique([pipelineId, key])
  @@index([tenantId, deletedAt])
  @@index([tenantId, pipelineId])
  @@index([tenantId, key])
  @@map("stages")
}

model Deal {
  id          String    @id @default(uuid())
  tenantId    String    @map("tenant_id")
  accountId   String    @map("account_id")
  pipelineId  String    @map("pipeline_id")
  stageId     String    @map("stage_id")
  ownerId     String?   @map("owner_id")
  name        String
  value       Decimal?  @db.Decimal(12, 2)
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  tenant   Tenant @relation(fields: [tenantId], references: [id])
  account  Account @relation(fields: [accountId], references: [id])
  pipeline Pipeline @relation(fields: [pipelineId], references: [id])
  stage    Stage @relation(fields: [stageId], references: [id])
  owner    User? @relation("DealOwner", fields: [ownerId], references: [id])
  activities Activity[]
  tasks     Task[]
  notes     Note[]
  attachments Attachment[]
  entityTags EntityTag[]

  @@index([tenantId, deletedAt])
  @@index([tenantId, accountId])
  @@index([tenantId, ownerId])
  @@index([tenantId, pipelineId])
  @@index([tenantId, stageId])
  @@map("deals")
}

model Activity {
  id          String    @id @default(uuid())
  tenantId    String    @map("tenant_id")
  type        ActivityType
  subject     String
  description String?
  accountId   String?   @map("account_id")
  contactId   String?   @map("contact_id")
  dealId      String?   @map("deal_id")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  tenant  Tenant  @relation(fields: [tenantId], references: [id])
  account Account? @relation(fields: [accountId], references: [id])
  contact Contact? @relation(fields: [contactId], references: [id])
  deal    Deal?    @relation(fields: [dealId], references: [id])

  @@index([tenantId, deletedAt])
  @@index([tenantId, accountId])
  @@index([tenantId, contactId])
  @@index([tenantId, dealId])
  @@map("activities")
}

model Task {
  id          String    @id @default(uuid())
  tenantId    String    @map("tenant_id")
  title       String
  dueDate     DateTime? @map("due_date")
  priority    TaskPriority
  status      TaskStatus
  assignedUserId String? @map("assigned_user_id")
  accountId   String?   @map("account_id")
  contactId   String?   @map("contact_id")
  dealId      String?   @map("deal_id")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])
  assignedUser User? @relation("TaskAssignee", fields: [assignedUserId], references: [id])
  account Account? @relation(fields: [accountId], references: [id])
  contact Contact? @relation(fields: [contactId], references: [id])
  deal    Deal?    @relation(fields: [dealId], references: [id])

  @@index([tenantId, deletedAt])
  @@index([tenantId, accountId])
  @@index([tenantId, contactId])
  @@index([tenantId, dealId])
  @@index([tenantId, assignedUserId])
  @@map("tasks")
}

model Note {
  id          String    @id @default(uuid())
  tenantId    String    @map("tenant_id")
  body        String
  accountId   String?   @map("account_id")
  contactId   String?   @map("contact_id")
  dealId      String?   @map("deal_id")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])
  account Account? @relation(fields: [accountId], references: [id])
  contact Contact? @relation(fields: [contactId], references: [id])
  deal    Deal?    @relation(fields: [dealId], references: [id])

  @@index([tenantId, deletedAt])
  @@index([tenantId, accountId])
  @@index([tenantId, contactId])
  @@index([tenantId, dealId])
  @@map("notes")
}

model Attachment {
  id          String    @id @default(uuid())
  tenantId    String    @map("tenant_id")
  filename    String
  url         String
  mimeType    String    @map("mime_type")
  size        Int
  accountId   String?   @map("account_id")
  contactId   String?   @map("contact_id")
  dealId      String?   @map("deal_id")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])
  account Account? @relation(fields: [accountId], references: [id])
  contact Contact? @relation(fields: [contactId], references: [id])
  deal    Deal?    @relation(fields: [dealId], references: [id])

  @@index([tenantId, deletedAt])
  @@index([tenantId, accountId])
  @@index([tenantId, contactId])
  @@index([tenantId, dealId])
  @@map("attachments")
}

model Tag {
  id          String    @id @default(uuid())
  tenantId    String    @map("tenant_id")
  name        String
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])
  entityTags EntityTag[]

  @@unique([tenantId, name])
  @@index([tenantId, deletedAt])
  @@map("tags")
}

model EntityTag {
  id        String @id @default(uuid())
  tenantId  String @map("tenant_id")
  tagId     String @map("tag_id")
  accountId String? @map("account_id")
  contactId String? @map("contact_id")
  dealId    String? @map("deal_id")

  tenant  Tenant @relation(fields: [tenantId], references: [id])
  tag     Tag @relation(fields: [tagId], references: [id])
  account Account? @relation(fields: [accountId], references: [id])
  contact Contact? @relation(fields: [contactId], references: [id])
  deal    Deal?    @relation(fields: [dealId], references: [id])

  @@index([tenantId, tagId])
  @@index([tenantId, accountId])
  @@index([tenantId, contactId])
  @@index([tenantId, dealId])
  @@map("entity_tags")
}

model AuditLog {
  id          String      @id @default(uuid())
  tenantId    String      @map("tenant_id")
  actorUserId String?     @map("actor_user_id")
  entityType  String      @map("entity_type")
  entityId    String      @map("entity_id")
  action      AuditAction
  beforeJson  Json?       @map("before_json")
  afterJson   Json?       @map("after_json")
  requestId   String      @map("request_id")
  ipAddress   String?     @map("ip_address")
  userAgent   String?     @map("user_agent")
  createdAt   DateTime    @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId, createdAt])
  @@index([tenantId, entityType, entityId])
  @@map("audit_logs")
}

model AutomationRule {
  id          String    @id @default(uuid())
  tenantId    String    @map("tenant_id")
  name        String
  trigger     String
  action      String
  enabled     Boolean   @default(true)
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId, deletedAt])
  @@index([tenantId, trigger])
  @@map("automation_rules")
}

model RefreshToken {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  familyId    String    @map("family_id")
  tokenHash   String    @map("token_hash")
  revokedAt   DateTime? @map("revoked_at")
  expiresAt   DateTime  @map("expires_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([familyId])
  @@index([expiresAt])
  @@map("refresh_tokens")
}
